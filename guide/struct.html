<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Struct 类型 | rainforest-js</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="rainforest-js 类型描述系统">
    
    <link rel="preload" href="/rainforest-js/assets/css/0.styles.9282ba87.css" as="style"><link rel="preload" href="/rainforest-js/assets/js/app.362b030c.js" as="script"><link rel="preload" href="/rainforest-js/assets/js/2.32dd98f9.js" as="script"><link rel="preload" href="/rainforest-js/assets/js/12.bdfe35b2.js" as="script"><link rel="prefetch" href="/rainforest-js/assets/js/10.d504831e.js"><link rel="prefetch" href="/rainforest-js/assets/js/11.300e5c95.js"><link rel="prefetch" href="/rainforest-js/assets/js/13.b4e6aac4.js"><link rel="prefetch" href="/rainforest-js/assets/js/3.d9ef3586.js"><link rel="prefetch" href="/rainforest-js/assets/js/4.09fd2c39.js"><link rel="prefetch" href="/rainforest-js/assets/js/5.42448316.js"><link rel="prefetch" href="/rainforest-js/assets/js/6.73c063ed.js"><link rel="prefetch" href="/rainforest-js/assets/js/7.1b6fdea7.js"><link rel="prefetch" href="/rainforest-js/assets/js/8.9a2b40c7.js"><link rel="prefetch" href="/rainforest-js/assets/js/9.2fec1ec9.js">
    <link rel="stylesheet" href="/rainforest-js/assets/css/0.styles.9282ba87.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/rainforest-js/" class="home-link router-link-active"><!----> <span class="site-name">rainforest-js</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/rainforest-js/guide/" class="nav-link router-link-active">
  教程
</a></div><div class="nav-item"><a href="/rainforest-js/api/" class="nav-link">
  API
</a></div> <a href="https://github.com/rainforesters/rainforest-js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/rainforest-js/guide/" class="nav-link router-link-active">
  教程
</a></div><div class="nav-item"><a href="/rainforest-js/api/" class="nav-link">
  API
</a></div> <a href="https://github.com/rainforesters/rainforest-js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>教程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/rainforest-js/guide/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/rainforest-js/guide/getting-started.html" class="sidebar-link">快速开始</a></li><li><a href="/rainforest-js/guide/typedesc.html" class="sidebar-link">类型描述</a></li><li><a href="/rainforest-js/guide/descriptors.html" class="sidebar-link">类型描述符</a></li><li><a href="/rainforest-js/guide/struct.html" aria-current="page" class="active sidebar-link">Struct 类型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#初识" class="sidebar-link">初识</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#模拟数据" class="sidebar-link">模拟数据</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#自动化" class="sidebar-link">自动化</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#定义函数" class="sidebar-link">定义函数</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#使用函数" class="sidebar-link">使用函数</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#观察子结构体" class="sidebar-link">观察子结构体</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#待观察的字段描述" class="sidebar-link">待观察的字段描述</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#notnil" class="sidebar-link">@notnil</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#diff" class="sidebar-link">@diff</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#or" class="sidebar-link">@or</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#同时使用多个函数" class="sidebar-link">同时使用多个函数</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#outcome" class="sidebar-link">outcome</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#structbody" class="sidebar-link">structbody</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#structof" class="sidebar-link">structof</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#自引用的结构体" class="sidebar-link">自引用的结构体</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#在修饰结构体上定义函数" class="sidebar-link">在修饰结构体上定义函数</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#继承-组合-扩展" class="sidebar-link">继承 &amp; 组合 &amp; 扩展</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#在实例上定义函数" class="sidebar-link">在实例上定义函数</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#字段类型描述符" class="sidebar-link">字段类型描述符</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#noinit" class="sidebar-link">@noinit</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#retain-release" class="sidebar-link">@retain &amp; @release</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#class" class="sidebar-link">@class</a></li><li class="sidebar-sub-header"><a href="/rainforest-js/guide/struct.html#change" class="sidebar-link">@change</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="struct-类型"><a href="#struct-类型" class="header-anchor">#</a> Struct 类型</h1> <p>这是一个简单又内涵丰富的类型。<br>
简单来讲，是由一个或多个字段组成的集合。<br> <strong>毫不客气的讲，这是数据结构化编程的灵魂。</strong></p> <h2 id="初识"><a href="#初识" class="header-anchor">#</a> 初识</h2> <p>我们可以很方便的定义它。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> bool<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>类型定义之后，我们需要初始化其实例，就可以使用了。<br>
初始化结构体时，所有字段都会自动初始化为类型的默认值。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">)</span>
<span class="token comment">// output: { name: '', sex: false }</span>

myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><p>这样，我们就得到了由安全字段类型组成的结构体实例。<br>
之后为字段的每次赋值都自动校验，这样就保障了整体的安全性。</p> <p>我们也可以在初始化的同时为字段赋值。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Amy'</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>另一个好用的是，我们可以直接初始化完整的结构体，包括子结构体。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> Contact <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  phone<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> bool<span class="token punctuation">,</span>
  contact<span class="token operator">:</span> Contact<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">)</span>
<span class="token comment">// output: { name: '', sex: false, contact: { phone: '', email: '' } }</span>
</code></pre></div><p>如果不想初始化子结构体，那么也很容易。或者使用 <a href="#noinit">@noinit</a> 描述符。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  contact<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">)</span>
<span class="token comment">// output: { name: '', sex: false, contact: null }</span>
</code></pre></div><h2 id="模拟数据"><a href="#模拟数据" class="header-anchor">#</a> 模拟数据</h2> <p>由于我们日常编程中，经常需要用到模拟数据。<br>
所以借助于前面学习的 <a href="/rainforest-js/guide/descriptors.html#mock">@mock</a> 描述符，我们可以很容易的生成模拟数据。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'@type'</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    <span class="token string">'@mock'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.5</span> <span class="token operator">?</span> <span class="token string">'Amy'</span> <span class="token operator">:</span> <span class="token string">'Ron'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'@type'</span><span class="token operator">:</span> bool<span class="token punctuation">,</span>
    <span class="token string">'@mock'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'@type'</span><span class="token operator">:</span> int32<span class="token punctuation">,</span>
    <span class="token string">'@mock'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 我们使用 wrapval({ '@mock': true }) 来生成模拟的数据</span>
<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">,</span> <span class="token function">wrapval</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'@mock'</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>如果我们并不想模拟全部字段，那么可以在初始化的同时为字段赋值。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token function">wrapval</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> <span class="token string">'@mock'</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Amy'</span><span class="token punctuation">,</span>
      sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>或者仅在某些字段上模拟。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Amy'</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token function">wrapval</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'@mock'</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面两个示例效果是相同的，只有 <code>age</code> 字段是模拟的。</p> <h2 id="自动化"><a href="#自动化" class="header-anchor">#</a> 自动化</h2> <p>现在，我们得到了结构化的由安全字段类型组成的集合。<br>
接下来，我们赋予其自动化编程的能力。<br>
由此，我们便实现了结构、安全、自动化的数据结构化编程。</p> <h2 id="定义函数"><a href="#定义函数" class="header-anchor">#</a> 定义函数</h2> <p>在保证结构体概念纯粹性的情况下，我们提供了隐式的函数来实现自动化。<br>
这样我们就能依旧按原有的简单方式来使用结构体。<br>
所以我们认知到，结构体上只有字段，并且一直都是只有字段，这就是简单纯粹性。</p> <p>使用 <a href="/rainforest-js/api/#funcdef">funcdef</a> 来定义函数。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> bool<span class="token punctuation">,</span>
  intro<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 定义函数</span>
<span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateIntroduction'</span><span class="token punctuation">,</span> <span class="token comment">// 函数名</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 待观察的字段描述（可以理解为参数）</span>
    name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 函数体</span>
    <span class="token comment">// 结构体的字段值，可以理解为函数返回值</span>
    self<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">My name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I am a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>sex <span class="token operator">?</span> <span class="token string">'girl'</span> <span class="token operator">:</span> <span class="token string">'boy'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>这和普通函数由名称、参数、函数体、返回值几部分组成的原理一样。<br>
其中参数部分，我们换成了 <strong>待观察的字段描述</strong> 这一个新的概念。<br>
返回值，我们换成了结构体的字段值。</p> <p>我们需要简单讲一下原理，来了解函数的行为方式。</p> <p>首先，我们的函数是定义于结构体上的，我们使用结构体的字段来作为参数。<br>
那么问题来了，什么时候触发函数呢？当然是参数全部传入的时候。<br>
问题二，怎么算是参数传入呢？字段赋值就是参数传入。<br>
所以，当待观察的字段都被赋值时，就会自动执行函数。<br>
我们由此也能获知一个特性，就是参数传入不依赖于顺序。这个概念也很重要。<br>
这样我们就容易理解了：<strong>当预期的字段数据都准备好时，会自动执行函数。</strong></p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>这就方便让我们的思维方式转变成：<strong>为结构体填充数据，就能获得结果。</strong><br>
编程就是填充数据。是不是豁然开朗了。</p></div> <h2 id="使用函数"><a href="#使用函数" class="header-anchor">#</a> 使用函数</h2> <p>我们不需要明确指定调用函数，我们只需要为结构体的字段赋值。<br>
如果函数应该执行，那么它就会在合适的时机执行。一切都是自动化的。</p> <p>所以我们对结构体的唯一操作就是为字段赋值。这保持了操作的单一性。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment">// name 和 sex 被赋值，会自动执行 generateIntroduction 生成个人介绍</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>
<span class="token comment">// output: My name is Amy, I am a girl.</span>
</code></pre></div><p>只要输入数据都准备好了，那么就能获得输出数据。<br>
这让我们无需思考背后的逻辑复杂性，只需要关注于输入和输出的结果。减少了许多心智负担。</p> <h2 id="观察子结构体"><a href="#观察子结构体" class="header-anchor">#</a> 观察子结构体</h2> <p>这是一个独具魅力的设计方案。<br>
我们不单能观察结构体的直接字段，也能观察到子结构体的字段。<br>
这赋予了我们强大的操控能力。我们会经常使用到。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> Contact <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  phone<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> bool<span class="token punctuation">,</span>
  contact<span class="token operator">:</span> Contact<span class="token punctuation">,</span>
  intro<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateIntroduction'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    contact<span class="token operator">:</span> <span class="token punctuation">{</span>
      phone<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      email<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">My name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I am a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>sex <span class="token operator">?</span> <span class="token string">'girl'</span> <span class="token operator">:</span> <span class="token string">'boy'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>intro <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
My phone number is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>phone<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and email is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
myself<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>phone <span class="token operator">=</span> <span class="token string">'xxx'</span>
myself<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>email <span class="token operator">=</span> <span class="token string">'xxx'</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>
<span class="token comment">// output:</span>
<span class="token comment">// My name is Amy, I am a girl.</span>
<span class="token comment">// My phone number is xxx and email is xxx.</span>
</code></pre></div><p>我们直接赋值新的子结构体，这也就意味着子结构体的字段全部发生变化。<br>
这两个示例的效果是相同的。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
myself<span class="token punctuation">.</span>contact <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>Contact<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  phone<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>
</code></pre></div><h2 id="待观察的字段描述"><a href="#待观察的字段描述" class="header-anchor">#</a> 待观察的字段描述</h2> <p>用来描述需要观察结构体上的哪些字段。也包括子结构体的字段。</p> <p>另外，我们也提供了几个描述符，可以描述字段的特殊行为。</p> <h2 id="notnil"><a href="#notnil" class="header-anchor">#</a> @notnil</h2> <p>用来表明该字段不能为空，也就是只有赋值不为空时，才算满足赋值条件。<br>
这让我们能在函数体里安全的使用字段。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateIntroduction'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    contact<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'@notnil'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 表明 contact 不能为空，所以函数体里可以安全使用该字段。</span>
      phone<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      email<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">My name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I am a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>sex <span class="token operator">?</span> <span class="token string">'girl'</span> <span class="token operator">:</span> <span class="token string">'boy'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.
My phone number is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>phone<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and email is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
myself<span class="token punctuation">.</span>contact <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token comment">// 此时尚未触发生成个人介绍的函数，</span>
<span class="token comment">// intro 依然为空，因为 contact 未被有效赋值</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>

myself<span class="token punctuation">.</span>contact <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>Contact<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  phone<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 此时 contact 才算被赋值，生成个人介绍</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>
<span class="token comment">// output:</span>
<span class="token comment">// My name is Amy, I am a girl.</span>
<span class="token comment">// My phone number is xxx and email is xxx.</span>
</code></pre></div><p>这样，即使子结构体暂时还不存在，我们也能提前预设条件，能够极大方便编程。<br>
一旦子结构体被赋值，那么就会满足条件触发函数。所有都按照预期正常执行。</p> <h2 id="diff"><a href="#diff" class="header-anchor">#</a> @diff</h2> <p>用来忽略相同的赋值，也就是只有赋值不同时，才算满足赋值条件。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateIntroduction'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">'@diff'</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    contact<span class="token operator">:</span> <span class="token punctuation">{</span>
      phone<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      email<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">My name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I am a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>sex <span class="token operator">?</span> <span class="token string">'girl'</span> <span class="token operator">:</span> <span class="token string">'boy'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.
My phone number is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>phone<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and email is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
myself<span class="token punctuation">.</span>contact <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>Contact<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  phone<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>
<span class="token comment">// output:</span>
<span class="token comment">// My name is Amy, I am a girl.</span>
<span class="token comment">// My phone number is xxx and email is xxx.</span>

myself<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token string">''</span>

myself<span class="token punctuation">.</span>contact <span class="token operator">=</span> myself<span class="token punctuation">.</span>contact
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">false</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
<span class="token comment">// 此时 intro 依然为空，因为 name 的值没有改变</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>

myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Ron'</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>
<span class="token comment">// output:</span>
<span class="token comment">// My name is Ron, I am a boy.</span>
<span class="token comment">// My phone number is xxx and email is xxx.</span>
</code></pre></div><p>如果应用于子结构体上，那么有两种情况。</p> <p>情况一，若未观察子结构体的字段，那么必须赋值不同的子结构体才算赋值。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  contact<span class="token operator">:</span> Contact<span class="token punctuation">,</span>
  intro<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateIntroduction'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    contact<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">'@diff'</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">My phone number is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>phone<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and email is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>contact <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>Contact<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  phone<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>
<span class="token comment">// output: My phone number is xxx and email is xxx.</span>

myself<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token string">''</span>

myself<span class="token punctuation">.</span>contact <span class="token operator">=</span> myself<span class="token punctuation">.</span>contact
<span class="token comment">// 此时 intro 依然为空，因为 contact 未改变</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>

myself<span class="token punctuation">.</span>contact <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>Contact<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  phone<span class="token operator">:</span> <span class="token string">'***'</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token string">'***'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>
<span class="token comment">// output: My phone number is *** and email is ***.</span>
</code></pre></div><p>情况二，如果也观察了子结构体的字段，那么除了必须赋值不同的结构体外，子结构体内部的字段改变也算是整个子结构体发生改变。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateIntroduction'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    contact<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'@diff'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      phone<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      email<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">My phone number is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>phone<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> and email is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>contact <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>Contact<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  phone<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token string">'xxx'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>
<span class="token comment">// output: My phone number is xxx and email is xxx.</span>

myself<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token string">''</span>

myself<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>phone <span class="token operator">=</span> <span class="token string">'***'</span>
myself<span class="token punctuation">.</span>contact<span class="token punctuation">.</span>email <span class="token operator">=</span> <span class="token string">'***'</span>
<span class="token comment">// 由于观察了内部字段，因此 contact 也算是发生了改变</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span>
<span class="token comment">// output: My phone number is *** and email is ***.</span>
</code></pre></div><h2 id="or"><a href="#or" class="header-anchor">#</a> @or</h2> <p>只要结构体的待观察字段有一个发生改变，那么就算所有字段都满足条件。<br>
只能用于描述结构体。</p> <p>之前都是在所有字段都发生改变时，才算满足触发函数的条件。<br>
现在我们来讲一下，不需要字段全部发生改变，就可以触发函数的情况。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> bool<span class="token punctuation">,</span>
  intro<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateIntroduction'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token string">'@or'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">My name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I am a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>sex <span class="token operator">?</span> <span class="token string">'girl'</span> <span class="token operator">:</span> <span class="token string">'boy'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Ron'</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span> <span class="token comment">// output: My name is Ron, I am a boy.</span>

myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span> <span class="token comment">// output: My name is Amy, I am a boy.</span>

myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself<span class="token punctuation">.</span>intro<span class="token punctuation">)</span> <span class="token comment">// output: My name is Amy, I am a girl.</span>
</code></pre></div><h2 id="同时使用多个函数"><a href="#同时使用多个函数" class="header-anchor">#</a> 同时使用多个函数</h2> <p>一个结构体上可以定义多个函数。<br>
其中，待观察的字段描述可以相同，也可以不同。
所以，某一个字段被赋值时，可能会同时执行多个函数，执行顺序按照函数定义的顺序，越早定义，越早执行。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> bool<span class="token punctuation">,</span>
  intro<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  homepage<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateIntroduction'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">My name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I am a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>sex <span class="token operator">?</span> <span class="token string">'girl'</span> <span class="token operator">:</span> <span class="token string">'boy'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateHomepage'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>homepage <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://example.com/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>sex <span class="token operator">?</span> <span class="token string">'female'</span> <span class="token operator">:</span> <span class="token string">'male'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      self<span class="token punctuation">.</span>name
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment">// 同时执行两个函数，执行顺序为：先生成个人介绍，然后生成个人首页</span>
<span class="token comment">// output: 1</span>
<span class="token comment">// output: 2</span>
</code></pre></div><p>即使靠后定义的函数，所观察的字段比之前定义的函数少，也严格按照定义顺序执行。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateIntroduction'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>intro <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">My name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I am a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>sex <span class="token operator">?</span> <span class="token string">'girl'</span> <span class="token operator">:</span> <span class="token string">'boy'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token function">funcdef</span><span class="token punctuation">(</span>
  MyStruct<span class="token punctuation">,</span>
  <span class="token string">'generateHomepage'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 只观察名字</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>homepage <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://example.com/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>self<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment">// 延后设置名字</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
<span class="token comment">// 同时执行两个函数，执行顺序为：先生成个人介绍，然后生成个人首页</span>
<span class="token comment">// output: 1</span>
<span class="token comment">// output: 2</span>
</code></pre></div><h2 id="outcome"><a href="#outcome" class="header-anchor">#</a> outcome</h2> <p>获取函数的执行结果。</p> <p>我们推荐将结果作为结构体的字段值，但是某些时候我们依然想获得这个函数的执行结果。<br>
比如，我们需要确认函数是否被执行了，因为函数可能是异步的。<br>
所以 <a href="/rainforest-js/api/#outcome">outcome</a> 返回一个 <code>Promise</code>。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 在函数执行前，提前预定函数的结果</span>
<span class="token keyword">const</span> asyncResult <span class="token operator">=</span> <span class="token function">outcome</span><span class="token punctuation">(</span>myself<span class="token punctuation">,</span> <span class="token string">'generateIntroduction'</span><span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token keyword">await</span> asyncResult <span class="token comment">// done</span>
</code></pre></div><p>大部分情况，我们更多需要获取的是结构体上的第一个函数结果。<br>
所以，我们提供了一个简便的方式，无需函数名就能获得结果。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> asyncResult <span class="token operator">=</span> <span class="token function">outcome</span><span class="token punctuation">(</span>myself<span class="token punctuation">)</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token keyword">await</span> asyncResult <span class="token comment">// done</span>
</code></pre></div><h2 id="structbody"><a href="#structbody" class="header-anchor">#</a> structbody</h2> <p>用来获取结构体类型的所有字段。</p> <p>有些时候结构体的字段类型是匿名的，所以我们提供了此方法来获取字段的类型。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  contact<span class="token operator">:</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    phone<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 获取匿名的字段类型</span>
<span class="token keyword">const</span> Contact <span class="token operator">=</span> <span class="token function">structbody</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span><span class="token punctuation">.</span>contact
</code></pre></div><h2 id="structof"><a href="#structof" class="header-anchor">#</a> structof</h2> <p>用来获取结构体实例的类型。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">structof</span><span class="token punctuation">(</span>myself<span class="token punctuation">)</span> <span class="token operator">===</span> MyStruct<span class="token punctuation">)</span>
<span class="token comment">// output: true</span>

<span class="token keyword">const</span> DecoratedStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'@type'</span><span class="token operator">:</span> MyStruct<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">structof</span><span class="token punctuation">(</span><span class="token function">typeinit</span><span class="token punctuation">(</span>DecoratedStruct<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> DecoratedStruct<span class="token punctuation">)</span>
<span class="token comment">// output: true</span>
</code></pre></div><h2 id="自引用的结构体"><a href="#自引用的结构体" class="header-anchor">#</a> 自引用的结构体</h2> <p>比如需要实现一个链表。</p> <p>我们首先需要定义一个空的结构体，然后再定义结构体的字段。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> Node <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">typedef</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    next<span class="token operator">:</span> Node<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  Node
<span class="token punctuation">)</span>
</code></pre></div><p>由于这是一个自引用的结构体，所以初始化时不会自动初始化自引用的字段，不然就会无限循环。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> node <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>Node<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
<span class="token comment">// output: { next: undefined }</span>
</code></pre></div><h2 id="在修饰结构体上定义函数"><a href="#在修饰结构体上定义函数" class="header-anchor">#</a> 在修饰结构体上定义函数</h2> <p>我们除了可以直接在结构体上定义函数，也可以在修饰的结构体上定义函数。<br>
这样我们就在不影响原结构体的情况下，赋予结构体更多的自动化能力。</p> <p>这符合修饰的准则。</p> <h2 id="继承-组合-扩展"><a href="#继承-组合-扩展" class="header-anchor">#</a> 继承 &amp; 组合 &amp; 扩展</h2> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>如果你熟悉继承，那么这里需要注意了，在这里没有任何的继承关系。<br>
如果你想扩展一个结构体，那么你应该重新定义一个新的结构体，采用组合的方式，将原结构体声明为一个字段。<br>
也正好，这种方式赋予了我们组合多个结构体的能力。并能保持简单清晰，这很有好处。</p></div> <h2 id="在实例上定义函数"><a href="#在实例上定义函数" class="header-anchor">#</a> 在实例上定义函数</h2> <p>我们提出另一个值得思考的问题，如何在一个已经实例化的结构体上定义函数呢？<br>
某些情况下，我们确实需要这种能力，来帮助我们扩展。</p> <p>假设可以在结构体实例上定义函数，那么会侵入影响这个实例，永远无法回到原始状态。<br>
所以，系统没有提供这种方法，就是为了保证实例的恒定稳定状态。<br>
不过，我们有更好的方案。</p> <p>我们可以定义一个新的结构体，并将这个实例的类型定义为子结构体字段，这样就可以在这个新的结构体上定义函数了。
由于我们可以观察到子结构体的内部字段，所以我们就能在保证实例状态的前提下，非侵入式的实现扩展。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 定义一个临时结构体类型</span>
<span class="token keyword">const</span> TempStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  ref<span class="token operator">:</span> <span class="token function">structof</span><span class="token punctuation">(</span>myself<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取实例的类型</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">funcdef</span><span class="token punctuation">(</span>
  TempStruct<span class="token punctuation">,</span>
  <span class="token string">'tempFunc'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    ref<span class="token operator">:</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ref<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ref<span class="token punctuation">.</span>sex <span class="token operator">?</span> <span class="token string">'female'</span> <span class="token operator">:</span> <span class="token string">'male'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token comment">// 初始化，将原实例附加到这个新的临时结构上</span>
<span class="token keyword">const</span> temp <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>TempStruct<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  ref<span class="token operator">:</span> myself<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 现在，就可以观察到子结构体的变化了</span>
myself<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Amy'</span>
myself<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment">// output: Amy female</span>

<span class="token comment">// 解除绑定也很简单</span>
temp<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token comment">// myself 又回到了原来的状态，仿佛一切都没有发生过</span>
</code></pre></div><h2 id="字段类型描述符"><a href="#字段类型描述符" class="header-anchor">#</a> 字段类型描述符</h2> <p>我们来介绍一些只适用于结构体的字段类型描述符。<br>
这能帮助我们了解结构体的一些特殊能力。</p> <h2 id="noinit"><a href="#noinit" class="header-anchor">#</a> @noinit</h2> <p>强制表明不自动初始化，始终返回 <code>undefined</code>。</p> <p>只有用作结构体的字段类型时，才有效。如果直接初始化，会忽略此标志，依然正常返回默认值。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> Contact <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'@noinit'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  phone<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> bool<span class="token punctuation">,</span>
  contact<span class="token operator">:</span> Contact<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// output: { name: '', sex: false, contact: undefined }</span>

<span class="token comment">// 不过直接初始化类型时，依然能获得正常的默认值。</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">typeinit</span><span class="token punctuation">(</span>Contact<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// output: { phone: '', email: '' }</span>
</code></pre></div><p>有些时候，我们并不想在初始化结构体时，默认初始化全部字段，希望某些字段默认为空。<br>
那么我们就可以使用此描述符。</p> <h2 id="retain-release"><a href="#retain-release" class="header-anchor">#</a> @retain &amp; @release</h2> <p>这是一对修饰符，用来修饰类型为 <code>Struct</code> 或 <code>any</code> 的字段类型。</p> <p>这并不常用，但在某些场景下，这会非常有用并且好用。<br>
比如：引用计数，或者追踪引用情况。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> Ref <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'@retain'</span><span class="token operator">:</span> <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">,</span> parentStruct<span class="token operator">:</span> Struct<span class="token punctuation">,</span> fieldName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>count<span class="token operator">++</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'@release'</span><span class="token operator">:</span> <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">,</span> parentStruct<span class="token operator">:</span> Struct<span class="token punctuation">,</span> fieldName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>count<span class="token operator">--</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  count<span class="token operator">:</span> int32<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Container <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  ref<span class="token operator">:</span> Ref<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>Ref<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token comment">// output: 0</span>
<span class="token comment">// 这是因为 ref 并为被任何结构体引用，所以计数为 0</span>

<span class="token keyword">const</span> conA <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>Container<span class="token punctuation">)</span>
<span class="token keyword">const</span> conB <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>Container<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>conA<span class="token punctuation">.</span>ref<span class="token punctuation">.</span>count<span class="token punctuation">,</span> conB<span class="token punctuation">.</span>ref<span class="token punctuation">.</span>count<span class="token punctuation">,</span> conA<span class="token punctuation">.</span>ref <span class="token operator">!==</span> ref<span class="token punctuation">,</span> conB<span class="token punctuation">.</span>ref <span class="token operator">!==</span> ref<span class="token punctuation">)</span>
<span class="token comment">// output: 1 1 true true</span>
<span class="token comment">// 因为 Container 初始化时会默认初始化内部的 Ref，</span>
<span class="token comment">// 并且会立刻被 Container 所引用，</span>
<span class="token comment">// 所以 conA.ref.count 为 1</span>

<span class="token keyword">const</span> refA <span class="token operator">=</span> conA<span class="token punctuation">.</span>ref
conA<span class="token punctuation">.</span>ref <span class="token operator">=</span> ref
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>count<span class="token punctuation">,</span> refA<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
<span class="token comment">// output: 1 0</span>
<span class="token comment">// 此时 ref 被 conA 引用了一次，所以 ref.count 为 1</span>
<span class="token comment">// 由于旧的 refA 被 conA 释放，所以 refA.count 为 0</span>

conB<span class="token punctuation">.</span>ref <span class="token operator">=</span> ref
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>count<span class="token punctuation">,</span> conA<span class="token punctuation">.</span>ref<span class="token punctuation">.</span>count<span class="token punctuation">,</span> conB<span class="token punctuation">.</span>ref<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
<span class="token comment">// output: 2 2 2</span>
<span class="token comment">// 此时 ref 被 conA 和 conB 引用了 2 次</span>

conA<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token comment">// output: 1</span>
conB<span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>count<span class="token punctuation">)</span> <span class="token comment">// output: 0</span>
</code></pre></div><h2 id="class"><a href="#class" class="header-anchor">#</a> @class</h2> <p>用来设置结构体的原型为自定义的类。</p> <p>这让我们能使用面向对象的方式来使用结构体，可以在结构体上使用方法。<br>
但是如非必要，我们不建议这么做。因为结构体应该保持纯粹性，只用来组织字段。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">Profile</span> <span class="token punctuation">{</span>
  name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  sex<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注意：这里不会调用</span>
    <span class="token comment">// 因为，通过 typeinit 初始化时，我们无法知晓构造参数的状态</span>
  <span class="token punctuation">}</span>

  <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">My name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, I am a </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>sex <span class="token operator">?</span> <span class="token string">'girl'</span> <span class="token operator">:</span> <span class="token string">'boy'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> MyStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'@class'</span><span class="token operator">:</span> Profile<span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> bool<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> myself <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>MyStruct<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Amy'</span><span class="token punctuation">,</span>
  sex<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myself <span class="token keyword">instanceof</span> <span class="token class-name">Profile</span><span class="token punctuation">)</span> <span class="token comment">// output: true</span>
myself<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// output: My name is Amy, I am a girl.</span>
</code></pre></div><h2 id="change"><a href="#change" class="header-anchor">#</a> @change</h2> <p>用来标记手动管理数据内部变动情况。<br>
适用于 <code>any</code> 类型。</p> <p>因为只有 <code>Struct</code> 是可以自动响应变化的，但有些情况下，我们也希望自定义的类型也能具备响应性。<br>
所以，那么我们就需要手动让其具备响应性。</p> <p>比如：我们希望数组元素的变动也能触发响应性。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> ReactiveArray <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'@type'</span><span class="token operator">:</span> array<span class="token punctuation">,</span>
  <span class="token string">'@change'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> ReactiveStruct <span class="token operator">=</span> <span class="token function">typedef</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  arr<span class="token operator">:</span> ReactiveArray<span class="token punctuation">,</span>
  hash<span class="token operator">:</span> int32<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">funcdef</span><span class="token punctuation">(</span>
  ReactiveStruct<span class="token punctuation">,</span>
  <span class="token string">'hash'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    arr<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>self<span class="token operator">:</span> Struct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> hash <span class="token operator">=</span> <span class="token number">5381</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> v <span class="token keyword">of</span> self<span class="token punctuation">.</span>arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hash <span class="token operator">+=</span> <span class="token punctuation">(</span>hash <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> v
    <span class="token punctuation">}</span>
    self<span class="token punctuation">.</span>hash <span class="token operator">=</span> hash <span class="token operator">|</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> rs <span class="token operator">=</span> <span class="token function">typeinit</span><span class="token punctuation">(</span>ReactiveStruct<span class="token punctuation">)</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> rs<span class="token punctuation">.</span>arr
arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">// 因为 arr 没有被重新赋值，所以函数不会执行</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token comment">// output: 0</span>

<span class="token comment">// 手动说明 arr 的内部发生变化了</span>
<span class="token function">change</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token comment">// output: 177573</span>
arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token function">change</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token comment">// output: 5859910</span>
</code></pre></div><p>内置的 <a href="/rainforest-js/api/#carray">CArray</a> 就是使用 <a href="/rainforest-js/api/#change">change</a> 和 <code>Proxy</code> 来实现的。</p> <div class="custom-block warning"><p class="custom-block-title">提示</p> <p>我还是我，但我已经不是原来的那个我了。</p></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/rainforesters/rainforest-js/edit/docs/docs/guide/struct.md" target="_blank" rel="noopener noreferrer">参与编辑文档🌲</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">3/4/2021, 2:58:42 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/rainforest-js/guide/descriptors.html" class="prev">
        类型描述符
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/rainforest-js/assets/js/app.362b030c.js" defer></script><script src="/rainforest-js/assets/js/2.32dd98f9.js" defer></script><script src="/rainforest-js/assets/js/12.bdfe35b2.js" defer></script>
  </body>
</html>
